typedef int fixed;
#define FM_PI ((fixed)0x0003243F)

const int16_t sintab[256] = {
	0, 402, 803, 1205, 1605, 2005, 2404, 2801,
	3196, 3589, 3980, 4369, 4756, 5139, 5519, 5896,
	6269, 6639, 7005, 7366, 7723, 8075, 8423, 8765,
	9102, 9434, 9759, 10079, 10393, 10701, 11002, 11297,
	11585, 11866, 12139, 12406, 12665, 12916, 13159, 13395,
	13622, 13842, 14053, 14255, 14449, 14634, 14810, 14978,
	15136, 15286, 15426, 15557, 15678, 15790, 15892, 15985,
	16069, 16142, 16206, 16260, 16305, 16339, 16364, 16379,
	16384, 16379, 16364, 16339, 16305, 16260, 16206, 16142,
	16069, 15985, 15892, 15790, 15678, 15557, 15426, 15286,
	15136, 14978, 14810, 14634, 14449, 14255, 14053, 13842,
	13622, 13395, 13159, 12916, 12665, 12406, 12139, 11866,
	11585, 11297, 11002, 10701, 10393, 10079, 9759, 9434,
	9102, 8765, 8423, 8075, 7723, 7366, 7005, 6639,
	6269, 5896, 5519, 5139, 4756, 4369, 3980, 3589,
	3196, 2801, 2404, 2005, 1605, 1205, 803, 402,
	0, -402, -803, -1205, -1605, -2005, -2404, -2801,
	-3196, -3589, -3980, -4369, -4756, -5139, -5519, -5896,
	-6269, -6639, -7005, -7366, -7723, -8075, -8423, -8765,
	-9102, -9434, -9759, -10079, -10393, -10701, -11002, -11297,
	-11585, -11866, -12139, -12406, -12665, -12916, -13159, -13395,
	-13622, -13842, -14053, -14255, -14449, -14634, -14810, -14978,
	-15136, -15286, -15426, -15557, -15678, -15790, -15892, -15985,
	-16069, -16142, -16206, -16260, -16305, -16339, -16364, -16379,
	-16384, -16379, -16364, -16339, -16305, -16260, -16206, -16142,
	-16069, -15985, -15892, -15790, -15678, -15557, -15426, -15286,
	-15136, -14978, -14810, -14634, -14449, -14255, -14053, -13842,
	-13622, -13395, -13159, -12916, -12665, -12406, -12139, -11866,
	-11585, -11297, -11002, -10701, -10393, -10079, -9759, -9434,
	-9102, -8765, -8423, -8075, -7723, -7366, -7005, -6639,
	-6269, -5896, -5519, -5139, -4756, -4369, -3980, -3589,
	-3196, -2801, -2404, -2005, -1605, -1205, -803, -402,
};

static int fixtoi(fixed v)
{
	return v>>16;
}

static fixed itofix(int v)
{
	return v<<16;
}

static fixed fixmul(fixed a, fixed b)
{
	int64_t ae = a;
	int64_t be = b;

	int64_t re = ae*be;
	re >>= 16;

	// TODO: Handle overflow

	return (fixed)re;
}

static fixed fixmulf(fixed a, fixed b)
{
	return (a>>8)*(b>>8);
}

static fixed fixdiv(fixed a, fixed b)
{
	int64_t ae = a;
	int64_t be = b;

	ae <<= 16;
	int64_t re = ae/be;

	// TODO: Handle overflow
	return (fixed)re;
}

static fixed fixsin(fixed ang)
{
	int i;

	// Clamp angle to 0 <= ang < 2 * FM_PI
	if(ang < 0) ang = ((FM_PI*2) - (-ang) % (FM_PI*2)) % (FM_PI*2);
	else ang = ang % (FM_PI*2);

	// Now wrap to -FM_PI <= ang < FM_PI
	if(ang >= FM_PI) ang -= FM_PI*2;

	// Get sign bit and deal with corner
	int sign = ang & 0x80000000;
	if(sign != 0) ang = -ang;

	// Calculate
	fixed acc1 = ang;
	fixed acc2 = fixmul(ang, ang);
	fixed acc3 = fixmul(acc2, acc1)/6;
	fixed acc5 = fixmul(acc2, acc3)/20;
	fixed acc7 = fixmul(acc2, acc5)/42;
	fixed ret = acc1 - acc3 + acc5 - acc7;

	// Invert if originally negative
	if(sign != 0) ret = -ret;

	// Return!
	return ret;
}

static fixed fixcos(fixed ang)
{
	return fixsin(ang + (FM_PI/2));
}

